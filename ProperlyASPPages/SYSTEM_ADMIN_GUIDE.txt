===========================================
SYSTEM ADMINISTRATOR IMPLEMENTATION GUIDE
===========================================

OVERVIEW
--------
The System Administrator feature provides a comprehensive role-based access control system for 
managing the Properly application. It allows designated staff members to manage users, companies, 
and system settings with granular permissions.

DATABASE SCHEMA
---------------
Run the SQL script: Data/Scripts/03_CreateSystemAdminTables.sql

This creates:
1. SystemAdminRole - Define roles with specific permissions
2. SystemAdmin - Administrator accounts linked to Identity users
3. SystemAdminActivityLog - Audit trail of all admin actions

Default roles created:
- Super Administrator (Full access)
- Administrator (Standard admin)
- Support Manager (User & company management)
- Support Agent (Basic support)
- Billing Manager (Billing access)
- Developer (System configuration)
- Analyst (Read-only reports)

SETUP INSTRUCTIONS
------------------

1. Run Database Script:
   Execute: ProperlyASPPages/Data/Scripts/03_CreateSystemAdminTables.sql
   This will create the required tables and seed default roles.

2. Create Your First Admin:
   After running the script, manually insert your first super admin:
   
   INSERT INTO SystemAdmin 
   (IdentityUserId, RoleId, FirstName, LastName, Email, IsSuperAdmin, IsActive, CreatedAt)
   VALUES 
   ('[YOUR_IDENTITY_USER_ID]', 1, 'Your', 'Name', 'your@email.com', 1, 1, GETUTCDATE());

   To get YOUR_IDENTITY_USER_ID:
   SELECT Id FROM AspNetUsers WHERE Email = 'your@email.com';

3. Access Admin Panel:
   Navigate to: /Admin
   Only users with SystemAdmin records can access this area.

PAGES STRUCTURE
---------------

/Admin                          - Main dashboard
/Admin/Admins/Index            - Manage system administrators
/Admin/Admins/Create           - Create new admin
/Admin/Companies/Index         - View all companies
/Admin/Users/Index             - View all users
/Admin/Activity                - View activity logs

AUTHORIZATION POLICIES
----------------------

The following policies are configured in Program.cs:

- IsSystemAdmin             - Basic admin access
- CanManageAdmins          - Create/edit other admins
- CanManageUsers           - Manage application users
- CanManageCompanies       - Manage company accounts
- CanViewReports           - Access reporting features
- CanManageSystem          - System configuration
- CanAccessBilling         - Billing and financial data
- CanManageSupport         - Support ticket management

USING AUTHORIZATION IN PAGES
-----------------------------

Apply to PageModel:
[Authorize(Policy = SystemAdminPolicies.IsSystemAdmin)]
public class MyPageModel : PageModel { }

Or check permissions programmatically:
var hasPermission = await _adminRepository.HasPermissionAsync(userId, SystemAdminPermission.ManageUsers);

ACTIVITY LOGGING
----------------

All admin actions are automatically logged:

await _adminRepository.LogActivityAsync(
    adminId,
    "Action Name",
    "Description of what happened",
    "EntityType",
    "EntityId",
    ipAddress,
    userAgent
);

REPOSITORY USAGE
----------------

Inject ISystemAdminRepository:

public class MyService
{
    private readonly ISystemAdminRepository _adminRepo;
    
    public MyService(ISystemAdminRepository adminRepo)
    {
        _adminRepo = adminRepo;
    }
    
    public async Task DoSomething(string userId)
    {
        var admin = await _adminRepo.GetByIdentityUserIdAsync(userId);
        if (admin == null) return; // Not an admin
        
        if (admin.IsSuperAdmin || admin.Role.CanManageUsers)
        {
            // Perform admin action
        }
    }
}

KEY FEATURES
------------

1. Role-Based Access Control
   - Flexible permission system
   - Multiple roles with different capabilities
   - Super Admin override for all permissions

2. Activity Logging
   - Complete audit trail
   - IP address and user agent tracking
   - Entity-level tracking

3. Admin Management
   - Create/edit/deactivate admins
   - View admin activity
   - Role assignment

4. Dashboard
   - Quick stats (companies, users, admins)
   - Recent activity feed
   - Quick action buttons based on permissions

5. Integration
   - Works seamlessly with ASP.NET Identity
   - Uses existing ApplicationUser accounts
   - Separate admin context from regular users

SECURITY CONSIDERATIONS
-----------------------

1. Always verify admin status before sensitive operations
2. Log all administrative actions for audit purposes
3. Use policy-based authorization on all admin pages
4. Never expose admin APIs without authorization
5. Regularly review admin access logs
6. Implement IP whitelisting for sensitive operations (optional)
7. Enable 2FA for all admin accounts (recommended)

EXTENDING THE SYSTEM
--------------------

To add new permissions:

1. Add to SystemAdminRole table (new column)
2. Add to SystemAdminRole model (C# property)
3. Add to SystemAdminPermission enum
4. Update SystemAdminRepository.HasPermissionAsync
5. Add new policy in SystemAdminPolicies.AddSystemAdminPolicies
6. Create migration script for database

TROUBLESHOOTING
---------------

Q: User can't access /Admin even though they have a SystemAdmin record
A: Check that IsActive = 1 and the IdentityUserId matches their AspNetUsers.Id

Q: Permission checks always fail
A: Ensure the admin's Role is active and permissions are set correctly in SystemAdminRole

Q: Activity logs not recording
A: Check that SystemAdminId is valid and the connection string is correct

FILES CREATED
-------------

Models:
- ProperlyASPPages/Models/SystemAdmin.cs

Repositories:
- ProperlyASPPages/Repositories/ISystemAdminRepository.cs
- ProperlyASPPages/Repositories/SystemAdminRepository.cs

Authorization:
- ProperlyASPPages/Authorization/SystemAdminAuthorization.cs

Pages:
- ProperlyASPPages/Pages/Admin/Index.cshtml[.cs]
- ProperlyASPPages/Pages/Admin/Activity.cshtml[.cs]
- ProperlyASPPages/Pages/Admin/Admins/Index.cshtml[.cs]
- ProperlyASPPages/Pages/Admin/Admins/Create.cshtml[.cs]
- ProperlyASPPages/Pages/Admin/Companies/Index.cshtml[.cs]
- ProperlyASPPages/Pages/Admin/Users/Index.cshtml[.cs]

Database:
- ProperlyASPPages/Data/Scripts/03_CreateSystemAdminTables.sql

Configuration:
- Updated ProperlyASPPages/Program.cs (added services and policies)

NEXT STEPS
----------

1. Run the database migration script
2. Create your first super admin user (see Setup Instructions)
3. Test access to /Admin
4. Create additional admin accounts as needed
5. Implement additional admin features:
   - Support ticket system
   - Billing management
   - System settings
   - Reporting dashboards
   - User impersonation (for support)

SUPPORT
-------

For issues or questions about the System Administrator feature, consult:
- This guide
- SystemAdminRepository.cs for data access patterns
- SystemAdminAuthorization.cs for authorization logic
- Activity logs for troubleshooting user access issues
