# Company Invitation System - Implementation Guide

## Overview
This system implements a secure, invitation-based approach for users to join companies in the multi-tenant property management application. Only Company Administrators can invite users, ensuring controlled access to company resources.

---

## Database Schema

### CompanyInvitation Table
```sql
CREATE TABLE dbo.CompanyInvitation
(
    InvitationId INT PRIMARY KEY IDENTITY(1,1),
    CompanyOrgId INT NOT NULL,
    Email NVARCHAR(256) NOT NULL,
    InvitedByUserId NVARCHAR(450) NOT NULL,
    InvitationToken NVARCHAR(100) NOT NULL UNIQUE,
    Status INT DEFAULT 0, -- Pending, Accepted, Declined, Expired, Cancelled
    Role NVARCHAR(50),
    InvitedFullName NVARCHAR(200),
    ExpiresAt DATETIME2 NOT NULL,
    AcceptedAt DATETIME2,
    AcceptedByUserId NVARCHAR(450),
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2
);
```

**Run the script:** `ProperlyASPPages/Data/Scripts/02_CreateCompanyInvitationTable.sql`

---

## Architecture

### Models
- **`CompanyInvitation.cs`** - Invitation entity with status tracking
- **`InvitationStatus` enum** - Pending, Accepted, Declined, Expired, Cancelled

### Repository Layer
- **`ICompanyRepository`** - Extended with invitation methods:
  - `CreateInvitationAsync()` - Create new invitation
  - `GetInvitationByTokenAsync()` - Retrieve by unique token
  - `GetPendingInvitationsByCompanyAsync()` - List pending invitations
  - `UpdateInvitationStatusAsync()` - Update invitation status
  - `IsUserAdminOfCompanyAsync()` - Check admin permissions

### Service Layer
- **`IOnboardingService`** - Extended with invitation methods:
  - `CreateInvitationAsync()` - Generate invitation with 7-day expiry
  - `AcceptInvitationAsync()` - Process invitation acceptance
  - `CanUserInviteToCompanyAsync()` - Validate permissions
  - `GetPendingInvitationsForCompanyAsync()` - List active invitations
  - `JoinCompanyViaInvitationAsync()` - Create CompanyUser from invitation

### Pages

#### Administrator Features
**`/Company/InviteUser`**
- Send invitations to new users
- View pending invitations
- Select role for invited user (User, Manager, Admin)
- Restricted to users with Admin role

#### User Features
**`/Onboarding/AcceptInvitation?token={guid}`**
- Validate invitation token
- Check email match
- Confirm user details
- Accept invitation and join company

**`/Onboarding/JoinCompany`**
- Updated to show "invitation required" message
- No longer allows direct company search/join

---

## User Flow

### 1. Administrator Invites User
```
Admin ? /Company/InviteUser
  ?
Enter: Email, Name (optional), Role
  ?
System generates unique token
  ?
Email sent with acceptance link
  ?
Invitation stored as "Pending"
```

### 2. User Accepts Invitation
```
User clicks email link
  ?
Redirected to /Onboarding/AcceptInvitation?token={guid}
  ?
Must be logged in (or prompted to login)
  ?
Validates:
  - Token exists
  - Not expired (7 days)
  - Email matches logged-in user
  - Status is Pending
  ?
User confirms full name
  ?
Creates CompanyUser record
  ?
Updates ApplicationUser.DomainTypes
  ?
Marks invitation as "Accepted"
  ?
Redirects to dashboard
```

### 3. New User Registration Flow
```
User Registers ? Identity Created
  ?
Checks: HasCompletedOnboarding?
  ?
If NO ? Redirect to /Onboarding/CompanySetup
  ?
User sees two options:
  1. Create New Company
  2. Join Company (shows invitation-required message)
```

---

## Security Features

### 1. **Token-Based Security**
- Unique GUID tokens (32 characters)
- One-time use only
- 7-day expiration
- Cannot be reused after acceptance

### 2. **Email Verification**
- Invitation email must match logged-in user's email
- Prevents unauthorized account associations

### 3. **Role-Based Access Control**
- Only users with "Admin" or "Administrator" role can invite
- Checked via `IsUserAdminOfCompanyAsync()`

### 4. **Status Tracking**
- Pending ? Active invitation
- Accepted ? Successfully joined
- Expired ? Past expiration date
- Cancelled ? Admin cancelled invitation

---

## Configuration

### Email Service
A basic logging email sender is included for development:
- **`Services/EmailSender.cs`** - Logs emails to console
- **Production:** Replace with actual email service (SendGrid, SMTP, etc.)

Example production implementation:
```csharp
public class SendGridEmailSender : IEmailSender
{
    private readonly SendGridClient _client;
    
    public async Task SendEmailAsync(string email, string subject, string htmlMessage)
    {
        var msg = new SendGridMessage()
        {
            From = new EmailAddress("noreply@properly.com", "Properly"),
            Subject = subject,
            HtmlContent = htmlMessage
        };
        msg.AddTo(new EmailAddress(email));
        
        await _client.SendEmailAsync(msg);
    }
}
```

### Connection Strings
Ensure `appsettings.json` has:
```json
{
  "ConnectionStrings": {
    "ProperlyIdentityDB": "...",
    "ProperlyDataDB": "..."
  }
}
```

---

## Testing Checklist

### Administrator Tests
- [ ] Can access `/Company/InviteUser` page
- [ ] Can send invitation with valid email
- [ ] Can see pending invitations list
- [ ] Can select different roles for invitees
- [ ] Non-admin users cannot access invite page

### Invitation Tests
- [ ] Invitation email contains correct link
- [ ] Token is unique for each invitation
- [ ] Invitation expires after 7 days
- [ ] Cannot accept invitation with wrong email
- [ ] Cannot reuse accepted invitation
- [ ] Cannot use invalid token

### User Acceptance Tests
- [ ] Must be logged in to accept
- [ ] Email must match invitation
- [ ] Can confirm/edit full name
- [ ] Creates CompanyUser record
- [ ] Updates ApplicationUser.DomainTypes
- [ ] Redirects to correct page after acceptance

### Security Tests
- [ ] Non-admin cannot invite users
- [ ] Expired invitations are rejected
- [ ] Email mismatch is rejected
- [ ] Token tampering is detected
- [ ] Used invitations cannot be reused

---

## Database Queries

### Check Pending Invitations for a Company
```sql
SELECT * FROM CompanyInvitation
WHERE CompanyOrgId = @CompanyId
  AND Status = 0
  AND ExpiresAt > GETUTCDATE()
ORDER BY CreatedAt DESC;
```

### Find Invitation by Token
```sql
SELECT * FROM CompanyInvitation
WHERE InvitationToken = @Token;
```

### Check if User is Admin
```sql
SELECT COUNT(1) FROM CompanyUser
WHERE IdentityUserId = @UserId
  AND CompanyOrgId = @CompanyId
  AND IsActive = 1
  AND (Role = 'Admin' OR Role = 'Administrator');
```

---

## Migration from Old System

If you previously had open company joining:

1. **Disable JoinCompany functionality** ?
   - Page now shows "invitation required" message
   - Direct joining methods deprecated

2. **Existing users remain unaffected**
   - Already associated CompanyUsers are unchanged
   - No data migration needed

3. **Going forward**
   - All new joins must use invitations
   - Administrators control company membership

---

## Extending the System

### Similar Patterns for Other Organizations

This invitation pattern can be replicated for:
- **OwnerOrg** - Property owners
- **ServiceOrg** - Service providers
- **Tenant** - Tenant management

Simply create similar tables:
- `OwnerInvitation`
- `ServiceInvitation`
- `TenantInvitation`

And duplicate the invitation service methods.

---

## Support & Troubleshooting

### Common Issues

**Issue:** "You do not have permission to invite users"
- **Solution:** Ensure user has "Admin" or "Administrator" role in CompanyUser table

**Issue:** "This invitation has expired"
- **Solution:** Admin must send a new invitation (7-day limit)

**Issue:** "Email mismatch"
- **Solution:** User must login with the email the invitation was sent to

**Issue:** Email not received
- **Solution:** Check spam folder; verify email service configuration

---

## Production Recommendations

1. **Email Service**
   - Replace `EmailSender` with production service (SendGrid, AWS SES, etc.)
   - Add email templates for professional appearance
   - Include company branding

2. **Notification System**
   - Notify admins when invitation is accepted
   - Send reminder emails for pending invitations
   - Alert when invitation expires

3. **Audit Logging**
   - Log all invitation creations
   - Track acceptance/rejection events
   - Monitor for suspicious activity

4. **UI Enhancements**
   - Add invitation cancellation feature
   - Resend invitation option
   - Bulk invitation upload

5. **Admin Dashboard**
   - View all company members
   - Manage user roles
   - Revoke access
   - View invitation history

---

## Related Files

### Database
- `Data/Scripts/02_CreateCompanyInvitationTable.sql`

### Models
- `Models/CompanyInvitation.cs`

### Services
- `Services/IOnboardingService.cs`
- `Services/OnboardingService.cs`
- `Services/EmailSender.cs`

### Repositories
- `Repositories/ICompanyRepository.cs`
- `Repositories/CompanyRepository.cs`

### Pages
- `Pages/Company/InviteUser.cshtml[.cs]`
- `Pages/Onboarding/AcceptInvitation.cshtml[.cs]`
- `Pages/Onboarding/JoinCompany.cshtml[.cs]` (updated)
- `Pages/Onboarding/CompanySetup.cshtml[.cs]` (updated)

### Configuration
- `Program.cs` (service registration)
- `appsettings.json` (connection strings)

---

## Conclusion

The invitation system provides secure, controlled access to company resources while maintaining a smooth user experience. Company administrators have full control over who can join their organization, and the system prevents unauthorized access through token-based security and email verification.
