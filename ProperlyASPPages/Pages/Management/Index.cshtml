@page
@model Management.ManagementIndexModel
@{
    ViewData["Title"] = "Management Dashboard";
}

<div class="container-fluid py-4">
    <div id="management-dashboard-root"></div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/lib/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/lib/ag-grid/styles/ag-grid.css">
    <link rel="stylesheet" href="~/lib/ag-grid/styles/ag-theme-alpine.css">
    <style>
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .dashboard-card {
            cursor: pointer;
            height: 100%;
        }
        .dashboard-card .card-body {
            padding: 2rem;
            text-align: center;
        }
        .dashboard-card .icon-container {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .dashboard-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .dashboard-card p {
            color: #6c757d;
            margin-bottom: 0;
        }
        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }
        .breadcrumb-item a {
            color: #0d6efd;
            text-decoration: none;
        }
        .breadcrumb-item a:hover {
            text-decoration: underline;
        }
        .ag-theme-alpine {
            --ag-header-background-color: #f8f9fa;
            --ag-odd-row-background-color: #ffffff;
            --ag-border-color: #dee2e6;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-inactive { background-color: #f8d7da; color: #721c24; }
        .status-renovation { background-color: #fff3cd; color: #856404; }
        .status-planned { background-color: #d1ecf1; color: #0c5460; }
        .status-sold { background-color: #e2e3e5; color: #383d41; }
        .view { display: none; }
        .view.active { display: block; }
    </style>
}

@section Scripts {
    <script src="~/lib/ag-grid/dist/ag-grid-community.min.js"></script>
    
    <script>
        const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new
        {
            currentUser = Model.CurrentUser != null ? new
            {
                id = Model.CurrentUser.ManagementUserId,
                name = Model.CurrentUser.FullName,
                email = Model.CurrentUser.Email,
                managementOrgId = Model.CurrentUser.ManagementOrgId
            } : null,
            pendingInvitations = Model.PendingInvitations,
            recentInvitations = Model.RecentInvitations.Select(inv => new
            {
                id = inv.InvitationId,
                email = inv.Email,
                role = inv.Role,
                invitedDate = inv.CreatedAt
            }).ToList()
        }));

        let currentView = 'dashboard';
        let gridApi = null;

        const statusMap = {
            0: { text: 'Active', class: 'status-active' },
            1: { text: 'Inactive', class: 'status-inactive' },
            2: { text: 'Under Renovation', class: 'status-renovation' },
            3: { text: 'Planned', class: 'status-planned' },
            4: { text: 'Sold', class: 'status-sold' }
        };

        function navigateToView(viewName) {
            currentView = viewName;
            renderApp();
        }

        function renderApp() {
            const root = document.getElementById('management-dashboard-root');
            root.innerHTML = '';

            if (currentView !== 'dashboard') {
                root.appendChild(createBreadcrumb());
            }

            const viewContainer = document.createElement('div');
            viewContainer.id = 'view-container';

            switch (currentView) {
                case 'properties':
                    viewContainer.appendChild(createPropertiesView());
                    break;
                case 'financials':
                    viewContainer.appendChild(createFinancialsView());
                    break;
                case 'people':
                    viewContainer.appendChild(createPeopleView());
                    break;
                case 'service':
                    viewContainer.appendChild(createServiceView());
                    break;
                default:
                    viewContainer.appendChild(createDashboardView());
            }

            root.appendChild(viewContainer);

            if (currentView === 'properties') {
                initializeGrid();
            }
        }

        function createBreadcrumb() {
            const nav = document.createElement('nav');
            nav.setAttribute('aria-label', 'breadcrumb');

            const ol = document.createElement('ol');
            ol.className = 'breadcrumb';

            const li1 = document.createElement('li');
            li1.className = 'breadcrumb-item';
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = 'Dashboard';
            a.onclick = (e) => { e.preventDefault(); navigateToView('dashboard'); };
            li1.appendChild(a);

            const li2 = document.createElement('li');
            li2.className = 'breadcrumb-item active';
            li2.setAttribute('aria-current', 'page');
            li2.textContent = currentView.charAt(0).toUpperCase() + currentView.slice(1);

            ol.appendChild(li1);
            ol.appendChild(li2);
            nav.appendChild(ol);

            return nav;
        }

        function createDashboardView() {
            const cards = [
                { id: 'properties', title: 'Properties', icon: 'bi-building', iconColor: '#0d6efd', description: 'Manage properties and units' },
                { id: 'financials', title: 'Financials', icon: 'bi-cash-coin', iconColor: '#198754', description: 'Track income and expenses' },
                { id: 'people', title: 'People', icon: 'bi-people', iconColor: '#6f42c1', description: 'Manage tenants and owners' },
                { id: 'service', title: 'Service', icon: 'bi-tools', iconColor: '#fd7e14', description: 'Maintenance and service requests' }
            ];

            const row = document.createElement('div');
            row.className = 'row g-4';

            cards.forEach(card => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-3';

                const cardDiv = document.createElement('div');
                cardDiv.className = 'card dashboard-card';
                cardDiv.onclick = () => navigateToView(card.id);

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                const iconContainer = document.createElement('div');
                iconContainer.className = 'icon-container';
                iconContainer.style.color = card.iconColor;
                const icon = document.createElement('i');
                icon.className = `bi ${card.icon}`;
                iconContainer.appendChild(icon);

                const h3 = document.createElement('h3');
                h3.textContent = card.title;

                const p = document.createElement('p');
                p.textContent = card.description;

                cardBody.appendChild(iconContainer);
                cardBody.appendChild(h3);
                cardBody.appendChild(p);
                cardDiv.appendChild(cardBody);
                col.appendChild(cardDiv);
                row.appendChild(col);
            });

            return row;
        }

        function createPropertiesView() {
            const container = document.createElement('div');

            const header = document.createElement('div');
            header.className = 'd-flex justify-content-between align-items-center mb-4';

            const h2 = document.createElement('h2');
            h2.textContent = 'Properties';

            const btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.onclick = () => alert('Add property functionality coming soon!');
            btn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Property';

            header.appendChild(h2);
            header.appendChild(btn);

            const gridDiv = document.createElement('div');
            gridDiv.id = 'properties-grid';
            gridDiv.className = 'ag-theme-alpine';
            gridDiv.style.height = '600px';
            gridDiv.style.width = '100%';

            container.appendChild(header);
            container.appendChild(gridDiv);

            return container;
        }

        function createFinancialsView() {
            const div = document.createElement('div');
            const h2 = document.createElement('h2');
            h2.textContent = 'Financials';
            const p = document.createElement('p');
            p.className = 'text-muted';
            p.textContent = 'Financial management features coming soon...';
            div.appendChild(h2);
            div.appendChild(p);
            return div;
        }

        function createPeopleView() {
            const div = document.createElement('div');
            const h2 = document.createElement('h2');
            h2.textContent = 'People';
            const p = document.createElement('p');
            p.className = 'text-muted';
            p.textContent = 'People management features coming soon...';
            div.appendChild(h2);
            div.appendChild(p);
            return div;
        }

        function createServiceView() {
            const div = document.createElement('div');
            const h2 = document.createElement('h2');
            h2.textContent = 'Service';
            const p = document.createElement('p');
            p.className = 'text-muted';
            p.textContent = 'Service request features coming soon...';
            div.appendChild(h2);
            div.appendChild(p);
            return div;
        }

        function statusCellRenderer(params) {
            if (params.value == null) return '';
            const status = statusMap[params.value] || { text: 'Unknown', class: '' };
            return `<span class="status-badge ${status.class}">${status.text}</span>`;
        }

        function actionsCellRenderer(params) {
            return `
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editProperty(${params.data.propertyId})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteProperty(${params.data.propertyId})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
        }

        function initializeGrid() {
            const columnDefs = [
                { field: 'propertyId', headerName: 'ID', width: 80, filter: 'agNumberColumnFilter' },
                { field: 'name', headerName: 'Name', width: 200, filter: 'agTextColumnFilter' },
                { field: 'type', headerName: 'Type', width: 120, filter: 'agTextColumnFilter' },
                { field: 'address', headerName: 'Address', width: 250, filter: 'agTextColumnFilter' },
                { field: 'city', headerName: 'City', width: 150, filter: 'agTextColumnFilter' },
                { field: 'state', headerName: 'State', width: 100, filter: 'agTextColumnFilter' },
                { field: 'postalCode', headerName: 'Zip', width: 100 },
                { field: 'unitsCount', headerName: 'Units', width: 100, filter: 'agNumberColumnFilter' },
                { field: 'squareFeet', headerName: 'Sq Ft', width: 120, filter: 'agNumberColumnFilter',
                  valueFormatter: params => params.value ? params.value.toLocaleString() : '' },
                { field: 'status', headerName: 'Status', width: 150, cellRenderer: statusCellRenderer,
                  filter: 'agSetColumnFilter' },
                { headerName: 'Actions', width: 120, cellRenderer: actionsCellRenderer, 
                  sortable: false, filter: false, pinned: 'right' }
            ];

            const gridOptions = {
                columnDefs: columnDefs,
                defaultColDef: {
                    sortable: true,
                    filter: true,
                    resizable: true
                },
                pagination: true,
                paginationPageSize: 20,
                paginationPageSizeSelector: [10, 20, 50, 100],
                domLayout: 'normal',
                rowSelection: 'single',
                onGridReady: (params) => {
                    gridApi = params.api;
                    loadProperties();
                }
            };

            const gridDiv = document.querySelector('#properties-grid');
            agGrid.createGrid(gridDiv, gridOptions);
        }

        async function loadProperties() {
            try {
                const response = await fetch('/api/properties');
                if (!response.ok) throw new Error('Failed to load properties');
                const properties = await response.json();
                if (gridApi) {
                    gridApi.setGridOption('rowData', properties);
                }
            } catch (error) {
                console.error('Error loading properties:', error);
                alert('Failed to load properties. Please try again.');
            }
        }

        function editProperty(id) {
            alert(`Edit property ${id} - functionality coming soon!`);
        }

        async function deleteProperty(id) {
            if (!confirm('Are you sure you want to delete this property?')) return;
            try {
                const response = await fetch(`/api/properties/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete property');
                loadProperties();
                alert('Property deleted successfully');
            } catch (error) {
                console.error('Error deleting property:', error);
                alert('Failed to delete property. Please try again.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderApp();
        });
    </script>
}
